#!/bin/bash

is_command_exists() {
    command -v "$1" &> /dev/null
}

check_yaml_key() {
    local yaml_file="$1"
    local yaml_key="$2"

    if [[ ! -f "$yaml_file" ]]; then
        echo "ğŸ”´ $yaml_file file not found."
        exit 1
    fi

    local value
    value=$(yq eval ".$yaml_key" "$yaml_file" 2>/dev/null)

    if [[ -z "$value" ]]; then
        echo "ğŸ”´ $yaml_key is not found in $yaml_file."
        exit 2
    fi

    if [[ "$value" == "true" ]]; then
        echo "ğŸŸ¢ $yaml_key is enabled (true)."
    elif [[ "$value" == "false" ]]; then
        echo "ğŸ”´ $yaml_key is disabled (false)."
    else
        echo "ğŸ”´ $yaml_key has an invalid value ($value)."
        exit 3
    fi
}


# Main
if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "ğŸŸ¡ Running on : macOS"
    
    if ! is_command_exists brew; then
        echo "ğŸ”´ Homebrew not installed. Visit https://brew.sh/ to install it"
        exit 1
    fi

    if ! is_command_exists yq; then
        echo "ğŸŸ¡ Installing yq..."
        brew install yq
        echo "ğŸŸ¢ yq successfuly installed"
    else
        echo "ğŸ”µ yq is already installed."
    fi

    if ! is_command_exists jq; then
        echo "ğŸŸ¡ Installing jq..."
        brew install jq
        echo "ğŸŸ¢ jq successfuly installed"
    else
        echo "ğŸ”µ jq is already installed."
    fi
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    echo "Running on: Linux"
    sudo apt-get update
    if ! is_command_exists yq; then
        echo "ğŸŸ¡ Installing yq..."
        sudo apt-get install -y yq
        echo "ğŸŸ¢ yq successfuly installed"
    else
        echo "ğŸ”µ yq is already installed."
    fi

    if ! is_command_exists jq; then
        echo "ğŸŸ¡ Installing jq..."
        sudo apt-get install -y jq
        echo "ğŸŸ¢ jq successfuly installed"
    else
        echo "ğŸ”µ jq is already installed."
    fi
else
    echo "ğŸ”´ Unsupported Operating System: $OSTYPE"
    exit 1
fi

echo ""
echo "ğŸ” Platform-specific CLI tools needed:"

# Detect and provide platform-specific installation advice
if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "ğŸ“ For your macOS system:"
    if ! is_command_exists gh; then
        echo "   - Install GitHub CLI: brew install gh"
    else
        echo "   âœ… GitHub CLI (gh) already installed"
    fi

    if ! is_command_exists glab; then
        echo "   - Install GitLab CLI: brew install glab"
        echo "     Or download from: https://gitlab.com/gitlab-org/cli/-/releases"
    else
        echo "   âœ… GitLab CLI (glab) already installed"
    fi
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    echo "ğŸ“ For your Linux system:"
    if ! is_command_exists gh; then
        echo "   - Install GitHub CLI: https://github.com/cli/cli/blob/trunk/docs/install_linux.md"
    else
        echo "   âœ… GitHub CLI (gh) already installed"
    fi

    if ! is_command_exists glab; then
        echo "   - Install GitLab CLI: https://gitlab.com/gitlab-org/cli/-/releases"
    else
        echo "   âœ… GitLab CLI (glab) already installed"
    fi
fi

echo ""
echo "ğŸš€ Setup complete! Run './badgetizr --help' to get started."