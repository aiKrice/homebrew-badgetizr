#!/bin/bash

# Tool versions for Linux manual installation
SHFMT_VERSION="v3.12.0"

is_command_exists() {
    command -v "$1" &> /dev/null
}

check_yaml_key() {
    local yaml_file="$1"
    local yaml_key="$2"

    if [[ ! -f "${yaml_file}" ]]; then
        echo "ðŸ”´ ${yaml_file} file not found."
        exit 1
    fi

    local value
    value=$(yq eval ".${yaml_key}" "${yaml_file}" 2> /dev/null)

    if [[ -z "${value}" ]]; then
        echo "ðŸ”´ ${yaml_key} is not found in ${yaml_file}."
        exit 2
    fi

    if [[ "${value}" == "true" ]]; then
        echo "ðŸŸ¢ ${yaml_key} is enabled (true)."
    elif [[ "${value}" == "false" ]]; then
        echo "ðŸ”´ ${yaml_key} is disabled (false)."
    else
        echo "ðŸ”´ ${yaml_key} has an invalid value (${value})."
        exit 3
    fi
}

# Parse arguments
CONTRIBUTOR_MODE=false
while [[ $# -gt 0 ]]; do
    case $1 in
        --contributor)
            CONTRIBUTOR_MODE=true
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: ./configure [--contributor]"
            exit 1
            ;;
    esac
done

# Main
if [[ "${OSTYPE}" == "darwin"* ]]; then
    echo "ðŸŸ¡ Running on: macOS"

    if ! is_command_exists brew; then
        echo "ðŸ”´ Homebrew not installed. Visit https://brew.sh/ to install it"
        exit 1
    fi

    # Select Brewfile based on mode
    if [[ "${CONTRIBUTOR_MODE}" == true ]]; then
        BREWFILE="Brewfile.dev"
        echo "ðŸ“¦ Installing contributor dependencies from Brewfile.dev..."
    else
        BREWFILE="Brewfile"
        echo "ðŸ“¦ Installing dependencies from Brewfile..."
    fi

    if [[ ! -f "${BREWFILE}" ]]; then
        echo "ðŸ”´ ${BREWFILE} not found"
        exit 1
    fi

    brew bundle --file="${BREWFILE}"
    echo "ðŸŸ¢ Dependencies installed successfully"
elif [[ "${OSTYPE}" == "linux-gnu"* ]]; then
    echo "ðŸŸ¡ Running on: Linux"
    sudo apt-get update

    # Basic dependencies
    if ! is_command_exists yq; then
        echo "ðŸŸ¡ Installing yq (mikefarah/yq)..."
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq
        echo "ðŸŸ¢ yq successfully installed"
    else
        echo "ðŸ”µ yq is already installed."
    fi

    # Contributor mode: install development tools
    if [[ "${CONTRIBUTOR_MODE}" == true ]]; then
        echo ""
        echo "ðŸ“¦ Installing contributor dependencies..."

        if ! is_command_exists shellcheck; then
            echo "ðŸŸ¡ Installing shellcheck..."
            sudo apt-get install -y shellcheck
            echo "ðŸŸ¢ shellcheck installed"
        else
            echo "ðŸ”µ shellcheck already installed"
        fi

        if ! is_command_exists shfmt; then
            echo "ðŸŸ¡ Installing shfmt ${SHFMT_VERSION}..."
            sudo wget -qO /usr/local/bin/shfmt "https://github.com/mvdan/sh/releases/download/${SHFMT_VERSION}/shfmt_${SHFMT_VERSION}_linux_amd64"
            sudo chmod +x /usr/local/bin/shfmt
            echo "ðŸŸ¢ shfmt ${SHFMT_VERSION} installed"
        else
            echo "ðŸ”µ shfmt already installed"
        fi

        if ! is_command_exists bats; then
            echo "ðŸŸ¡ Installing bats-core..."
            sudo apt-get install -y bats
            echo "ðŸŸ¢ bats-core installed"
        else
            echo "ðŸ”µ bats already installed"
        fi

        if ! is_command_exists kcov; then
            echo "ðŸŸ¡ Installing kcov..."
            sudo apt-get install -y kcov
            echo "ðŸŸ¢ kcov installed"
        else
            echo "ðŸ”µ kcov already installed"
        fi
    fi

    echo ""
    echo "ðŸ” Platform-specific CLI tools needed:"
    echo "ðŸ“ For your Linux system:"
    if ! is_command_exists gh; then
        echo "   - Install GitHub CLI: https://github.com/cli/cli/blob/trunk/docs/install_linux.md"
    else
        echo "   âœ… GitHub CLI (gh) already installed"
    fi

    if ! is_command_exists glab; then
        echo "   - Install GitLab CLI: https://gitlab.com/gitlab-org/cli/-/releases"
    else
        echo "   âœ… GitLab CLI (glab) already installed"
    fi
else
    echo "ðŸ”´ Unsupported Operating System: ${OSTYPE}"
    exit 1
fi

# Configure Git hooks (contributor mode only)
if [[ "${CONTRIBUTOR_MODE}" == true ]]; then
    echo ""
    echo "ðŸ”§ Configuring Git hooks..."

    # Setup git hooks path (cannot use include.path for security reasons)
    CURRENT_HOOKS_PATH=$(git config --local core.hooksPath 2> /dev/null || echo "")
    if [[ "${CURRENT_HOOKS_PATH}" == "githooks" ]]; then
        echo "ðŸ”µ Git hooks already configured."
    else
        git config --local core.hooksPath githooks
        echo "ðŸŸ¢ Git hooks configured successfully (using githooks/)"
    fi

    if [[ -d "githooks" ]]; then
        chmod +x githooks/* 2> /dev/null
        echo "ðŸŸ¢ Git hooks directory ready: githooks/"
    fi
fi

echo ""
echo "ðŸš€ Setup complete! Run './badgetizr --help' to get started."
