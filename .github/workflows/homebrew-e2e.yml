name: Homebrew E2E Test

on:
  pull_request:
    branches: [develop, master]
    paths:
      - 'Formula/badgetizr.rb'
      - 'badgetizr'
      - 'utils.sh'
      - 'providers/**'
      - '.github/workflows/homebrew-e2e.yml'
  push:
    branches: [develop, master]
    paths:
      - 'Formula/badgetizr.rb'
      - 'badgetizr'
      - 'utils.sh'
      - 'providers/**'
      - '.github/workflows/homebrew-e2e.yml'

jobs:
  test-homebrew-installation:
    name: Test Homebrew libexec installation on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, macos-14, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install gh glab yq jq

      - name: Install badgetizr from local formula
        run: |
          echo "üì¶ Installing badgetizr via Homebrew..."
          brew install --build-from-source ./Formula/badgetizr.rb

      - name: Verify installation structure
        run: |
          echo "=== üìÇ Checking libexec structure ==="
          INSTALL_PATH=$(brew --prefix)/opt/badgetizr/libexec
          echo "Installation path: $INSTALL_PATH"
          ls -la "$INSTALL_PATH"

          echo ""
          echo "=== üîó Checking bin wrapper ==="
          WRAPPER_PATH=$(brew --prefix)/bin/badgetizr
          echo "Wrapper path: $WRAPPER_PATH"
          cat "$WRAPPER_PATH"

          echo ""
          echo "=== ‚úÖ Verifying UTILS_PATH is set ==="
          if grep -q "UTILS_PATH" "$WRAPPER_PATH"; then
            echo "‚úÖ UTILS_PATH found in wrapper"
            grep "UTILS_PATH" "$WRAPPER_PATH"
          else
            echo "‚ùå UTILS_PATH not found in wrapper!"
            echo "This would cause the v1.5.5 bug regression!"
            exit 1
          fi

      - name: Test badgetizr --version
        run: |
          echo "üß™ Testing: badgetizr --version"
          badgetizr --version

      - name: Test badgetizr --help
        run: |
          echo "üß™ Testing: badgetizr --help"
          badgetizr --help | head -20

      - name: Test badgetizr error handling
        run: |
          echo "üß™ Testing: badgetizr without --pr-id (should fail gracefully)"
          if badgetizr 2>&1 | grep -q "Error.*--pr-id"; then
            echo "‚úÖ Error message correct"
          else
            echo "‚ùå Expected error message not found"
            exit 1
          fi

      - name: Test providers are accessible
        run: |
          echo "üß™ Testing: providers directory is accessible"
          INSTALL_PATH=$(brew --prefix)/opt/badgetizr/libexec
          if [ -d "$INSTALL_PATH/providers" ]; then
            echo "‚úÖ Providers directory found"
            ls -la "$INSTALL_PATH/providers"
          else
            echo "‚ùå Providers directory not found!"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Uninstalling badgetizr..."
          brew uninstall badgetizr || true

  homebrew-e2e-summary:
    name: Homebrew E2E Summary
    runs-on: ubuntu-latest
    needs: [test-homebrew-installation]
    if: always()

    steps:
      - name: Check all macOS versions passed
        run: |
          echo "=== Homebrew E2E Test Results ==="
          echo "Job result: ${{ needs.test-homebrew-installation.result }}"

          if [ "${{ needs.test-homebrew-installation.result }}" != "success" ]; then
            echo "‚ùå Homebrew E2E tests failed on at least one macOS version"
            echo "Check the logs above for details on which OS failed"
            exit 1
          fi

          echo "‚úÖ Homebrew E2E tests passed on all macOS versions (13, 14, latest)"
