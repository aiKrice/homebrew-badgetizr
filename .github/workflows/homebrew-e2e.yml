name: Homebrew E2E Test

on:
  pull_request:
    branches: [develop, master]
    paths:
      - 'Formula/badgetizr.rb'
      - 'badgetizr'
      - 'utils.sh'
      - 'providers/**'
      - '.github/workflows/homebrew-e2e.yml'
  push:
    branches: [develop, master]
    paths:
      - 'Formula/badgetizr.rb'
      - 'badgetizr'
      - 'utils.sh'
      - 'providers/**'
      - '.github/workflows/homebrew-e2e.yml'

jobs:
  test-homebrew-installation:
    name: Test Homebrew libexec installation on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-13, macos-14, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install badgetizr from local formula
        run: |
          echo "üì¶ Installing badgetizr via Homebrew..."
          # Create temporary tap to install from local formula
          mkdir -p $(brew --repository)/Library/Taps/badgetizr-test
          cp -r . $(brew --repository)/Library/Taps/badgetizr-test/homebrew-badgetizr

          # Install from the temporary tap
          brew install --build-from-source badgetizr-test/badgetizr/badgetizr

      - name: Verify installation structure
        run: |
          echo "=== üìÇ Checking libexec structure ==="
          INSTALL_PATH=$(brew --prefix)/opt/badgetizr/libexec
          echo "Installation path: $INSTALL_PATH"
          ls -la "$INSTALL_PATH"

          echo ""
          echo "=== üîó Checking bin wrapper ==="
          WRAPPER_PATH=$(brew --prefix)/bin/badgetizr
          echo "Wrapper path: $WRAPPER_PATH"
          cat "$WRAPPER_PATH"

          echo ""
          echo "=== ‚úÖ Verifying UTILS_PATH is set ==="
          if grep -q "UTILS_PATH" "$WRAPPER_PATH"; then
            echo "‚úÖ UTILS_PATH found in wrapper"
            grep "UTILS_PATH" "$WRAPPER_PATH"
          else
            echo "‚ùå UTILS_PATH not found in wrapper!"
            echo "This would cause the v1.5.5 bug regression!"
            exit 1
          fi

      - name: Test badgetizr --version
        run: |
          echo "üß™ Testing: badgetizr --version"
          badgetizr --version

      - name: Test badgetizr --help
        run: |
          echo "üß™ Testing: badgetizr --help"
          badgetizr --help | head -20

      - name: Test badgetizr error handling
        run: |
          echo "üß™ Testing: badgetizr without --pr-id (should fail with exit code 1)"

          set +e
          OUTPUT=$(badgetizr 2>&1)
          EXIT_CODE=$?
          set -e

          echo "Exit code: $EXIT_CODE"
          echo "Output: $OUTPUT"

          if [ $EXIT_CODE -ne 1 ]; then
            echo "‚ùå Expected exit code 1, got $EXIT_CODE"
            exit 1
          fi

          if ! echo "$OUTPUT" | grep -q "Error.*--pr-id"; then
            echo "‚ùå Expected error message not found in output"
            exit 1
          fi

          echo "‚úÖ Error handling validated (exit code 1 + correct error message)"

      - name: Test providers are accessible
        run: |
          echo "üß™ Testing: providers directory is accessible"
          INSTALL_PATH=$(brew --prefix)/opt/badgetizr/libexec
          if [ -d "$INSTALL_PATH/providers" ]; then
            echo "‚úÖ Providers directory found"
            ls -la "$INSTALL_PATH/providers"
          else
            echo "‚ùå Providers directory not found!"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Uninstalling badgetizr..."
          brew uninstall badgetizr || true

          echo "üßπ Removing temporary tap..."
          brew untap badgetizr-test/badgetizr || true
          rm -rf $(brew --repository)/Library/Taps/badgetizr-test || true

  homebrew-e2e-summary:
    name: Homebrew E2E Summary
    runs-on: ubuntu-latest
    needs: [test-homebrew-installation]
    if: always()

    steps:
      - name: Check all macOS versions passed
        run: |
          echo "=== Homebrew E2E Test Results ==="
          echo "Matrix job result: ${{ needs.test-homebrew-installation.result }}"

          # With fail-fast: false, we need to check the overall result
          # Possible values: success, failure, cancelled, skipped
          RESULT="${{ needs.test-homebrew-installation.result }}"

          if [ "$RESULT" = "success" ]; then
            echo "‚úÖ All macOS versions (13, 14, latest) passed Homebrew E2E tests"
            exit 0
          elif [ "$RESULT" = "failure" ]; then
            echo "‚ùå At least one macOS version failed Homebrew E2E tests"
            echo "Please check the logs above to identify which OS (13, 14, or latest) failed"
            exit 1
          elif [ "$RESULT" = "cancelled" ]; then
            echo "‚ö†Ô∏è Homebrew E2E tests were cancelled"
            exit 1
          else
            echo "‚è≠Ô∏è Homebrew E2E tests were skipped"
            exit 0
          fi
