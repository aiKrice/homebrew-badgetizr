#!/usr/bin/env bash
# pre-commit hook - Runs shfmt and shellcheck on modified shell files

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if required tools are installed
check_dependencies() {
    local missing_deps=()

    if ! command -v shfmt &> /dev/null; then
        missing_deps+=("shfmt")
    fi

    if ! command -v shellcheck &> /dev/null; then
        missing_deps+=("shellcheck")
    fi

    if [ ${#missing_deps[@]} -ne 0 ]; then
        echo -e "${RED}Error: Missing required dependencies: ${missing_deps[*]}${NC}" >&2
        echo -e "${YELLOW}Please run './configure' at the root of the project to install dependencies.${NC}" >&2

        # Send notification if on macOS
        if [[ "$OSTYPE" == "darwin"* ]] && command -v terminal-notifier &> /dev/null; then
            terminal-notifier -title "Badgetizr Pre-commit Failed" \
                -message "Missing dependencies: ${missing_deps[*]}. Run ./configure" \
                -sound "Basso"
        fi

        exit 1
    fi
}

# Send macOS notification
send_notification() {
    local title="$1"
    local message="$2"
    local sound="${3:-default}"

    if [[ "$OSTYPE" == "darwin"* ]] && command -v terminal-notifier &> /dev/null; then
        terminal-notifier -title "$title" -message "$message" -sound "$sound"
    fi
}

# Get list of shell files that are added, modified, or renamed (not deleted)
get_shell_files() {
    git diff --cached --name-only --diff-filter=AMR | grep -E '\.(sh|bash)$|^badgetizr$|^configure$' || true
}

# Run shfmt on files
run_shfmt() {
    local files=("$@")

    if [ ${#files[@]} -eq 0 ]; then
        return 0
    fi

    echo -e "${YELLOW}Running shfmt formatter...${NC}"

    local shfmt_failed=()
    local shfmt_fixed=()

    for file in "${files[@]}"; do
        if [ -f "$file" ]; then
            if shfmt -w -ci -sr "$file" 2>/dev/null; then
                if git diff --name-only "$file" | grep -q "$file"; then
                    shfmt_fixed+=("$file")
                    git add "$file"
                fi
            else
                shfmt_failed+=("$file")
                echo -e "${RED}✗ Failed to format: $file${NC}" >&2
            fi
        fi
    done

    if [ ${#shfmt_fixed[@]} -gt 0 ]; then
        echo -e "${GREEN}✓ Auto-formatted ${#shfmt_fixed[@]} file(s) and staged changes${NC}"
        for file in "${shfmt_fixed[@]}"; do
            echo -e "  - $file"
        done
    fi

    if [ ${#shfmt_failed[@]} -gt 0 ]; then
        send_notification "Badgetizr Pre-commit Failed" \
            "shfmt failed on ${#shfmt_failed[@]} file(s)" \
            "Basso"

        echo -e "\n${RED}shfmt failed on the following files:${NC}" >&2
        for file in "${shfmt_failed[@]}"; do
            echo -e "${RED}  - $file${NC}" >&2
        done

        return 1
    fi

    return 0
}

# Run shellcheck on files
run_shellcheck() {
    local files=("$@")

    if [ ${#files[@]} -eq 0 ]; then
        return 0
    fi

    echo -e "${YELLOW}Running shellcheck linter...${NC}"

    local shellcheck_output
    local shellcheck_exit_code=0

    # Run shellcheck and capture output
    shellcheck_output=$(shellcheck -x "${files[@]}" 2>&1) || shellcheck_exit_code=$?

    if [ $shellcheck_exit_code -ne 0 ]; then
        send_notification "Badgetizr Pre-commit Failed" \
            "shellcheck found issues in your code" \
            "Basso"

        echo -e "${RED}✗ ShellCheck found issues:${NC}" >&2
        echo "$shellcheck_output" >&2
        echo -e "\n${YELLOW}Please fix the issues above before committing.${NC}" >&2

        return 1
    fi

    echo -e "${GREEN}✓ ShellCheck passed${NC}"
    return 0
}

# Main execution
main() {
    check_dependencies

    # Get shell files from staging area
    mapfile -t shell_files < <(get_shell_files)

    if [ ${#shell_files[@]} -eq 0 ]; then
        echo -e "${GREEN}No shell files to check${NC}"
        exit 0
    fi

    echo -e "${YELLOW}Checking ${#shell_files[@]} shell file(s)...${NC}"

    # Run shfmt first (auto-format and stage changes)
    if ! run_shfmt "${shell_files[@]}"; then
        exit 1
    fi

    # Re-get the list after shfmt (in case files were staged)
    mapfile -t shell_files < <(get_shell_files)

    # Run shellcheck
    if ! run_shellcheck "${shell_files[@]}"; then
        exit 1
    fi

    echo -e "${GREEN}✓ Pre-commit checks passed${NC}"
}

main "$@"
