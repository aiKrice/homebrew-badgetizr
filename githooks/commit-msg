#!/usr/bin/env bash
# commit-msg hook - Sends success notification after successful commit

# Arguments passed by Git
COMMIT_MSG_FILE=$1

# Send macOS notification
send_notification() {
    local title="$1"
    local message="$2"
    local sound="${3:-default}"
    local logo="${4:-logo.png}"

    if [[ "${OSTYPE}" == "darwin"* ]]; then
        # Use local terminal-notifier v3 if available, fallback to system version
        local notifier
        if [[ -x "./terminal-notifier.app/Contents/MacOS/terminal-notifier" ]]; then
            notifier="./terminal-notifier.app/Contents/MacOS/terminal-notifier"
        elif command -v terminal-notifier &> /dev/null; then
            notifier="terminal-notifier"
        else
            return 0 # No notifier available, skip silently
        fi

        # Convert relative path to file:// URL for v3 compatibility
        local logo_url
        if [[ -f "${logo}" ]]; then
            logo_url="file://$(cd "$(dirname "${logo}")" && pwd)/$(basename "${logo}")"
            "${notifier}" -title "${title}" -message "${message}" -sound "${sound}" -contentImage "${logo_url}"
        else
            "${notifier}" -title "${title}" -message "${message}" -sound "${sound}"
        fi
    fi
}

# Main execution
main() {
    # Extract commit message for notification (first line only)
    local commit_summary
    commit_summary=$(head -n 1 "${COMMIT_MSG_FILE}" | sed 's/^#.*//')

    if [[ -n "${commit_summary}" ]]; then
        # Success notification
        send_notification "ðŸŸ¢ Badgetizr Commit Successful" \
            "${commit_summary}" \
            "Glass"
    fi
}

main "$@"
